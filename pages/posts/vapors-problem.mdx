import { Layout } from 'lib/components'
import { RichLink, RichList, RichListNoBox, CodeBlockTitle, MdxImage } from "lib/components/original/parts";

export const meta = {
  title: '【Laravel】Vaporの利用にあたってのメリット・デメリット',
  date: '2024-03-03T22:16:01Z',
  tags: [
    'Blog',
    '初級者向け',
    'プログラミング',
    'Laravel',
    'PHP',
    'Vapor',
    'バックエンド',
    'フレームワーク'
  ],
  description: '前回までLaravel Vaporの基本的な使い方を説明してきましたが、今回はVaporを利用するにあたってメリット・デメリットを説明してまいります。'
}

## 概要

ここのところ本ブログでは、Laravelのエコシステムの1つである[Larvel Vapor](https://vapor.laravel.com/)について
説明をしてきました。

しばらく使ってみたところ、 **ぶっちゃけLaravel Vaporの使い勝手ってどうなの？** というところを
個人的な意見とはなってしまいますが、まとめていきたいと思います。

## メリット編

#### AWSに基本的に依拠している。

最初にAWSのIAM(Identity and Access Management)でトークンを発行し、それに基づいて
サーバを **AWS Lambda** (サーバレスファンクション)で動かしています。

**公式サイトのドキュメントにもそのように書かれています。**

参考サイト: [Introduction ​What Is Vapor?](https://docs.vapor.build/introduction.html)

よって、Vaporのビジネスのキモであるサーバを立ち上げたり落としたりする処理を除いて、<span className="hoso">結局のところ裏側はAWSを動かしているのと同じ</span>なので、
説明がしやすいアーキテクチャではあります。

#### Laravelのサーバレス環境をどこよりも早く簡単に作れる。

Laravelはバックエンドフレームワークなので、基本的に今までApache/Nginxと組み合わせて使うものというイメージが強かったです。
以前に、大規模な開発案件で[AWS Fargate](https://aws.amazon.com/jp/fargate/)と組み合わせて利用したのはみましたが、これは
**運用コスト・構築コストともに個人開発では到底治らないレベル** となっていますし、

Elastic BeanstalkやAWSではないですが、Herokuなど選択肢をいろいろ検討したこともありましたが、
結果的にWebサーバに設置する方法が一番楽で慣れていて早そうだなという結論に至りやすかったです。

**後続のコストのことを無視さえできれば** 、速さ・簡単さでは一番だと思いました。

## デメリット編

#### 環境の削除が基本的に面倒

AWSにはあるあるですが、削除時はVaporではなく、結局AWSのGUIに入って行わなければいけないので結構面倒でした。

Vaporで構築した環境には、VPCが含まれており、IPが付いているようで、
2024/2/1から発生したVPCに付加されたIPへの課金に伴い、費用がかかります。

（以下の記事も参考にさせていただきました）

参考記事: [AWS の Public IPv4 アドレスに 2024年2月1日から請求が開始される件について影響を事前に確認する](https://blog.serverworks.co.jp/checking-the-impact-of-starting-charges-for-aws-public-ipv4-addresses-from-february-1-2024)

以前はこの点の費用がかからなかったのですが、課金されて地味に痛かったです。

##### VPCを消すためにはインターネットゲートウェイを消さないといけない

具体的にはVPCを消すにあたり以下の問題がありました。

インターネットゲートウェイはいわばWWWから遮断された箱への入り口となります。
(NIC という言葉がもはやピンとこない時代かもしれませんが、、）

VPCを削除するにあたり、まずIGWを消さないといけないようです。
<MdxImage month="202403" image="vp501.png" annotation="IGWを消さないと警告が出る。" />

消さないとVPCが消せなかったので削除します。

<MdxImage month="202403" image="vp502.png" annotation="IGWに移動し" />
<MdxImage month="202403" image="vp503.png" annotation="削除する" />

今度はVPCが消せました。この辺りの警告とかも慣れていない人ですと詰まってしまいそうですよね。

<MdxImage month="202403" image="vp504.png" annotation="VPCの削除に成功" />

Vaporは入り口は簡単ですが出口は悩んでしまうかもしれません。

#### 削除というアクションは本質的に避けたい => 作りやすく・消しにくい

**DBを削除するときの問題** です。

VaporのDBは[実質RDSとなっているというのを先日までの連載の中で書きました。](https://moldspoon.jp/blog/posts/add-db-to-vapor#db%E3%81%AE%E4%BD%9C%E6%88%90)

いくらRDS終了時のバックアップなどフェイルセーフが複数に渡り用意されているAWSとはいえ、<span className="hoso">データを削除する
という行為はエンジニアとしてとても神経を使います。</span>

その心理により、**ファイルが削除できず結果としてバックアップを残すことで長期間にわたり
従量課金がかかってしまうということになりかねない** と思います。

以前にElastic Beanstalkでインフラを作った時にも感じましたが、 **個人レベル・とても小さい法人で開発段階のWebサービスでは
自動でとはいえVPCを作るのは正直ファットな気がします。** 



## 結論

#### 商用でハードに使っていない中での結論

あらかじめお断りをさせていただきますが、あくまでテスト目的で触った上での結論となりますので何卒ご容赦ください。

**私は日常的にVaporを使うことはなさそうだな** と思いました。ただ、 **ユースケースによっては当てはまるかもしれない** とは
思っています。

#### 最低構成とはいえ2000円程度のコストをどう考えるのか？

あくまでの私の事例ですが、2024/2/1~2/23の22日間で以下のコストが発生していました

```
RDS => 6.72ドル
VPC => 4.1ドル
S3 => 利用した分だけ。
Lambda(Webサーバ) => 無料枠に収まっていた
```

<MdxImage month="202403" image="vp505.png" annotation="最も高額なRDSの内訳" />

今回は2/23にインフラをシャットダウンしてしまったため、月次の比較となっておらずすみません。
<br />
<span className="hoso">ただ、月間さんすると最低でも13ドル/月くらい。 つまり2000円程度のコストはかかると見込まねばならない</span>わけです。
<br />
**オンプレミスの頃のように専用サーバで1万円〜を必要としていた時代に比べるとこれは安いかも** しれませんが、

AWS Lightsail や さくらのVPSのようにSSHでログインでき、専用サーバと同じようにインフラが使える今の時代。
**2000円が最低金額というのが果たしてどうか、、** とは思います。

AWS EC2や Google Compute EngineのようにバックアップやIPのアタッチ等において高度に管理できるクラウドであれば
その金額は受け入れられますが、<span className="hoso">選択肢としては個人的には微妙だな</span>と思いました。
<br />

事実、ログについては **VaporのLogs画面から確認せねばならず、** Vercel等にも言えることですが、Linuxサーバのログの方が使い勝手はいいと言わざるを得ない部分もあります。

（もっともそこまでVercelなどにおいてAPI経由でデータを取るなどログを高度に使ってはいないので、専門的に使っていらっしゃる方からは別の意見があるかもしれませんが...） 

#### パフォーマンス視点での観点が未調査

とはいえ、<span className="hoso">結局Vaporの魅力はスケーラブルな点であり、ユーザーが急増したりしても利用に影響を及ぼさず、増強できるところにあります。</span>
Laravelをバックエンドとしているサービスのユーザーが急増するタイミングで移行してみないと本当の意味で意味のある評価はできないと思いました。
<br />
でも **ユーザー急増の時って、DBの、それもWrite系のクエリの処理が追いつかなくなって問題になることが多い** ので
果たしてRDSをバックボーンとしているVaporでどこまで費用をかけすぎずに増強できるのかな、という点はテストを行っていない現段階でもちょっと疑問とはなりますが...

#### AWSからやってくる料金アラートが地味に気になる

最後に余談となりますが...Vaporでプロジェクトを作成するときに **料金の閾値を超えた場合メールで警告が来るように設定できます。** 

- 月次の見積もり金額(AWSの予測でどのくらいかかるか出す)
- 実績値

のいずれかが引っかかりそうになるとメールがVaporから送られてきます。

私のアカウントは他のプロジェクトと兼用だったので、**速攻で上限値に到達したらしく、即時メールが届きました。** これが地味に気になった次第でした...。

<MdxImage month="202403" image="vp506.png" annotation="料金警告はありがたいが、共有プロジェクトでは意味がない..." />


## まとめ
いろいろ触ってみましたが、Vaporは[銀の弾丸](https://www.itmedia.co.jp/im/articles/0706/25/news104.html)とはならないなと思った次第でした。
Vaporに限らず、 **そのプロジェクトにピッタリ当てはまるインフラか？はかなり難しい課題だと思う** ので、これからも
<span className="hoso">いろいろ使い分けて、お客様に対して最適なソリューションをご提供できればと思った次第</span>でした。
<br />
**最後までお読みいただきありがとうございました！** <br />
引き続き当ブログをよろしくお願いいたします。<br />

export default function Page({ children }) {
  return (
    <Layout meta={meta}>
      <>
        {children}
      </>
    </Layout>
  )
}

