import { Layout } from 'lib/components'
import RichList from "lib/components/original/parts/RichList"
import RichListNoBox from "lib/components/original/parts/RichListNoBox"
import CodeBlockTitle from "lib/components/original/parts/CodeBlockTitle"
import MdxImage from "../../lib/components/original/parts/MdxImage"

export const meta = {
  title: 'Next.jsè£½ãƒ–ãƒ­ã‚°ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ç›®æ¬¡ã‚’è¿½åŠ ã™ã‚‹ã€‚',
  date: '2023-09-15T10:50:00.000Z',
  tags: [
    'Blog',
    'çµŒé¨“è€…å‘ã‘',
    'Next.js',
    'Vercel',
    'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰',
    'ç›®æ¬¡',
    'Toc',
    'Markdown',
    'mdx',
    'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°'
  ]
}

ä»Šå›ã¯ã€Next.jsã§ä½œã‚‰ã‚Œã¦ã„ã‚‹ã“ã®ãƒ–ãƒ­ã‚°ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ç›®æ¬¡ã‚’è¿½åŠ ã—ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚Wordpressã ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€ç™ºãªã®ã§ã™ãŒã€Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®æ¬¡ã£ã¦ã©ã†ä½œã‚Œã°ã„ã„ã‚“ã ã‚ã†ï¼Ÿã¨ã„ã†ã¨ã“ã‚ã‹ã‚‰ã§ã™ã­ğŸ˜…

### æœ¬è¨˜äº‹ã«ã¤ã„ã¦

#### å¿…è¦ãªæŠ€è¡“

- Next.js
- react-dom
- @mdxjs-react (MDXãƒ–ãƒ­ã‚°ã§ã®åˆ©ç”¨ã‚’æƒ³å®š)
- tailwindcss (Next13ãªã‚‰ã°ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã•ã‚Œã¦ã„ã¾ã™)

ã“ã¡ã‚‰ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ¡ç”¨ã—ã¦ã„ã‚‹ã®ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚

#### è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«

ãƒ–ãƒ­ã‚°ã«ç›®æ¬¡(Table of Contents = Toc)ã‚’è¿½åŠ ã™ã‚‹

<RichList
  color="orange"
  title="è¦ä»¶å®šç¾©"
  list={
  [
    '.mdxè¨˜äº‹ã®ã€è¦‹å‡ºã—(h1,h2,h3...h6)ãŒéšå±¤çš„ã«ç›®æ¬¡ã«ãªã‚‹ã‚ˆã†ã«ä½œæˆã™ã‚‹',
    'ä½œæˆã—ãŸç›®æ¬¡ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è¦‹å‡ºã—ã«é·ç§»ã™ã‚‹ã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã‚‚~#è¦‹å‡ºã—åã¨ãªã‚‹ã€‚',
    'æŠ˜ã‚Šè¿”ã—ã¯è€ƒæ…®ã—ãªã„'
  ]
} />


### è¨­è¨ˆ

ç›®æ¬¡ã®ç”Ÿæˆã¯ã€
1. .mdxãƒ•ã‚¡ã‚¤ãƒ«ã®è¦‹å‡ºã—ã‚’ã€å…¥ã‚Œå­æ§‹é€ ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ ¼ç´ã—
2. æ©Ÿæ¢°çš„ã«`<ul>`ãŠã‚ˆã³`<li>`ã‚¿ã‚°ã§ç”Ÿæˆ

ã¨ã„ã†æµã‚Œã§å‡¦ç†ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®é¡ã®æ©Ÿèƒ½ã®ä½œæˆã‚’è¡Œã£ãŸäººã§ã‚ã‚Œã°æƒ³åƒãŒã¤ãã¯ãšã€‚
å•é¡Œã¯ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯ã®å®Ÿè£…ã ãŒã€çµè«–ã‹ã‚‰è¨€ã†ã¨[MDX Provider](https://mdxjs.com/docs/using-mdx/#mdx-provider)ã«ã‚ˆã‚Šã€è¨˜äº‹å†…ã®h1~h6ã‚’ä¸€å¾‹ã§æ›¸ãæ›ãˆã‚‹ã“ã¨ã§å¯¾å¿œã§ãã¾ã™ã€‚

<RichList
  color="orange"
  title="è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ"
  list={
  [
    'Tocã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚',
    'remark-tocã‚’ä½¿ã£ã¦å„ãƒ–ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³éƒ¨ã‚’typescriptã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚‹ã€‚',
    'Tocã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã£ã¦ç›®æ¬¡ã‚’çµ„ã¿ç«‹ã¦ã‚‹'
  ]
} />

### å®Ÿè£…

#### ç›®æ¬¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨å¿…è¦ãªå‡¦ç†ã‚’ä½œã‚‹

##### Toc.tsxã‚’ä½œã‚‹

ä»Šå›ã¯**Next13ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®appãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**ã§`lib/components`ä»¥ä¸‹ã«**Toc.tsx**ã¨è¨€ã†åç§°ã§ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
å„ãƒšãƒ¼ã‚¸å…±é€šã§å‘¼ã³å‡ºã•ã‚Œã‚‹layout.tsxã§ã€.mdxã‹ã‚‰å¤‰æ›ã•ã‚ŒãŸhtmlã‚’ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã™ã“ã¨ã§ã€ç›®æ¬¡ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

<CodeBlockTitle title="lib/components/Toc.tsx" />

```typescript
import { Configs } from "lib/utils";
import { useEffect, useRef, useState } from "react";
import Link from "next/link";

type Prop = {
  body: string
};

// å…¥ã‚Œå­ã®ç›®æ¬¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‹å®šç¾©ã™ã‚‹
type TocData = {
  [key: string]: TocData
};

const Toc: React.FC<Prop> = ({ body }) => {
  const [tocObject, setTocObject] = useState<{ [key: string]: any }>({});

  const showNumberString = false // trueã«ã™ã‚‹ã¨ã€ç« ç«‹ã¦ã®ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  useEffect(() => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(body, "text/html");

    const headings = doc.querySelectorAll("h1, h2, h3, h4, h5, h6");

    // ã“ã®stackã§éšå±¤æ§‹é€ ã‚’ç®¡ç†ã™ã‚‹ã€‚
    const stack: any[] = [];
    let tocData: TocData = {};

    headings.forEach((heading) => {
      const level = parseInt(heading.tagName.charAt(1), 10);
      const text = heading.textContent || "";

      while (stack.length && stack[stack.length - 1].level >= level) {
        stack.pop();
      }

      let parent = tocData;

      stack.forEach(item => {
        parent = parent[item.text];
      });

      parent[text] = {};

      stack.push({ text: text, level: level });
    });

    setTocObject(tocData);
  }, [body]);

  const renderToc = (
    data: { [key: string]: any },
    parentNumbers: number[] = []
  ) => {
    return (
      <ul className="toc-list px-0 mx-3 my-2 list-none">
        {Object.keys(data).map((key, index) => {
          const currentNumbers = [...parentNumbers, index + 1];
          const numberString = currentNumbers.join("-");

          return (
            <li key={key} className="p-0 m-0 text-xs">
              <Link href={`#${key.replace(/\s+/g, "-").toLowerCase()}`} className="text-black dark:text-white">
                {showNumberString && numberString + ". "}{key}
              </Link>
              {renderToc(data[key], currentNumbers)}
            </li>
          )
        })}
      </ul>
    );
  };

  // ä»¥ä¸‹taildinw

  return (
    <div className={`toc xl:fixed xl:pl-8 xl:top-16 hidden xl:block `}>
      <div className="toc-box p-2 rounded-xl break-words">
        <div className="rounded-xl shadow-2xl bg-white dark:bg-black px-4 py-2">
          <p className="pt-0 font-bold">ç›®æ¬¡</p>
          {renderToc(tocObject)}
        </div>
      </div>
      <style jsx>{`
        .toc-box {
          background: linear-gradient(0deg, rgb(195,34,175,1) 0%, rgba(253,187,45,1) 100%)
        }
        .toc {
          margin-left: ${Configs.layouts.pageWidth};
        }
        .toc-list li {
          padding: 0px;
        }
      `}</style>
    </div>
  );
};

export default Toc;
```

##### layout.tsxã«Toc.tsxã®å‘¼ã³å‡ºã—å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹

è¨˜äº‹ãƒšãƒ¼ã‚¸å…±é€šã§å‘¼ã°ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã€Tocã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ãã®éš›ã«ã€.mdxãƒšãƒ¼ã‚¸ã‹ã‚‰`React.ReactNode`å‹ã®`children`ãŒæ¸¡ã•ã‚Œã¦ãã¾ã™ãŒã€ã“ã‚Œã‚’
stringã«ç½®æ›ã—ãŸä¸Šã§ã€Tocã«æ¸¡ã—ã¾ã™ã€‚

ã‚ãªãŸã®ã”åˆ©ç”¨ä¸­ã®layout.tsxã«åˆã‚ã›ã¦ã€å®Ÿè£…ã—ã¦ãã ã•ã„

<CodeBlockTitle title="app/layout.tsx" />

```typescript
// ... importã¯çœç•¥

import Toc from 'lib/components/Toc'
import { renderToString } from 'react-dom/server';

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {

  let childrenHtml = '';
  if (React.isValidElement(children)) {
    // React.ReactNodeã‚’htmlã«ç½®æ›
    childrenHtml = renderToString(children);
  }

ã€€// ä»¥ä¸‹ã®<html><Navbar>ãªã©ã®ã‚¿ã‚°ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚‚ã®ãã®ã¾ã¾ã§ã™ã€‚
  // Tocã‚’å‘¼ã³å‡ºã™ç®‡æ‰€ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ã¦ã©ã†ã
  return (
    <html lang="en">
      <body>
        <Navbar />
          <main className="">{children}</main>
          <Toc body={childrenHtml} />
        <Footer />
      </body>
    </html>
  )
}

```

##### mdx-component.tsxã‚’è¨­ç½®ã—ã€h1~h6ã®idå±æ€§ã‚’åŸ‹ã‚è¾¼ã‚€ã‚ˆã†ã«å¤‰æ›´

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆç›´ä¸‹**ã«mdx-component.tsxã‚’è¨­ç½®ã—ã€
ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ã§ã®ç§»å‹•ã®ãŸã‚å¿…è¦ãªå±æ€§ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã¾ã›ã€‚

<CodeBlockTitle title="mdx-component.tsx" />

```typescript
import type { MDXComponents } from 'mdx/types';

export function useMDXComponents(components: MDXComponents): MDXComponents {

  const CustomH1: React.FC<{ children: React.ReactNode }> = ({ children }) => (
    <h1 id={(children as string).toLowerCase().replace(/\s+/g, '-')}>{children}</h1>
  );
  const CustomH2: React.FC<{ children: React.ReactNode }> = ({ children }) => (
    <h2 id={(children as string).toLowerCase().replace(/\s+/g, '-')}>{children}</h2>
  );
  const CustomH3: React.FC<{ children: React.ReactNode }> = ({ children }) => (
    <h3 id={(children as string).toLowerCase().replace(/\s+/g, '-')}>{children}</h3>
  );
  const CustomH4: React.FC<{ children: React.ReactNode }> = ({ children }) => (
    <h4 id={(children as string).toLowerCase().replace(/\s+/g, '-')}>{children}</h4>
  );
  const CustomH5: React.FC<{ children: React.ReactNode }> = ({ children }) => (
    <h5 id={(children as string).toLowerCase().replace(/\s+/g, '-')}>{children}</h5>
  );
  const CustomH6: React.FC<{ children: React.ReactNode }> = ({ children }) => (
    <h6 id={(children as string).toLowerCase().replace(/\s+/g, '-')}>{children}</h6>
  );

  return {
    // ä»–ã«å‡¦ç†ãŒã‚ã‚Œã°ã“ã“ã«è¿½åŠ 
    h1: CustomH1,
    h2: CustomH2,
    h3: CustomH3,
    h4: CustomH4,
    h5: CustomH5,
    h6: CustomH6
  }
}
```

### å‹•ä½œç¢ºèªï¼ˆãƒ†ã‚¹ãƒˆï¼‰

ãƒ­ãƒ¼ã‚«ãƒ«ã§`yarn run dev`ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èµ·å‹•ã—ã€è¨˜äº‹ãƒšãƒ¼ã‚¸ã§ç›®æ¬¡ãŒå‹•ã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

<MdxImage month="202309" image="page-anchor-link.gid" month="202309" />

ï¼ˆã¡ãªã¿ã«ã€ãƒ¢ãƒã‚¤ãƒ«ã§ã¯æ¶ˆã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚[https://dev.classmethod.jp/](ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰)ã•ã‚“ãªã©ã‚‚ç›®æ¬¡ã‚’æ¶ˆã™ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã®ã§ï¼‰

### å‚è€ƒæ–‡çŒ®

##### Markdown All in One
[ã€vscodeã€‘Markdownã«ãŠã‘ã‚‹ç›®æ¬¡(TOC)ã®ä½œæˆã«ã€Markdown All in OneãŒä¾¿åˆ©ã ã£ãŸä»¶](https://qiita.com/eyuta/items/b1a53f3da8c5f8e7f41d)
VSCodeã«ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã€.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ã ã‘ã§è‡ªå‹•ã§ç›®æ¬¡ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’ä½¿ãˆãŸã‚‰ç¬æ®ºã ãªã€ã¨æ€ã£ãŸã®ã§ã™ãŒæ®‹å¿µğŸ˜¢

##### MDX Providerã‚’ä½¿ã£ãŸã‚¿ã‚°ã®æ›¸ãæ›ãˆ
[https://titanicrising.jp/blog/nextjs-mdx]
ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯éƒ¨åˆ†ã¯ã€ã“ã®æ–¹æ³•ã‚’ä½¿ã£ã¦æ›¸ãæ›ãˆã‚‰ã‚Œãã†ãªã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

##### Tocã®å…ˆè¡Œå®Ÿç¸¾
[https://www.cyishere.dev/blog/toc-for-mdx-with-nextjs](Table of Contents for MDX with Next.js)
ã“ã¡ã‚‰ã®æ–¹ã®ãƒ–ãƒ­ã‚°å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ãŠã‹ã’ã§ã€ç‹¬è‡ªå®Ÿè£…ã‚‚ã‚¢ãƒªã ãªã¨æ€ãˆã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚


### ã¾ã¨ã‚ãƒ»æ„Ÿæƒ³

å®Ÿè£…è‡ªä½“ã¯ã€ãªã‹ãªã‹æ¥½ã—ã‹ã£ãŸã§ã™ãŒã‹ã‚†ã„ã¨ã“ã‚ã«æ‰‹ãŒå±Šãç›®æ¬¡ã‚’ä½œã‚‹ãŸã‚ã«ã¯ã€ã•ã‚‰ãªã‚‹è»Šè¼ªã®å†ç™ºæ˜ã‚’ã™ã‚‹æ„ŸãŒæ¼‚ã£ã¦ãã¾ã™ã­...ã€‚
ãŸã ã€**Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®äººã«ã¯Wordpressã‚ˆã‚Šã¯çµ¶å¯¾ã«è‡ªåˆ†ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã™ã‚‹å½¢ã«å®Ÿè£…ã—ã‚„ã™ã„**ã¨æ€ã†ã®ã§ã€**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…åŠ›ãŒã‚ã‚‹äººã‚„ã€Next.jsã‚’ä»Šå¾Œã‚‚ä½¿ã„ç¶šã‘ãŸã„ï¼ã¨ã„ã†æ–¹**ãªã‚‰ã“ã®æ–¹æ³•ã¯å¤§ã„ã«ã‚¢ãƒªã‹ã¨æ€ã£ãŸæ¬¡ç¬¬ã§ã—ãŸã€‚
<br />
ã“ã®è¨˜äº‹ãŒä½•ã‹ã®ãŠå½¹ã«ç«‹ã¦ã‚Œã°å¹¸ã„ã§ã™ã€‚<br />
æœ€å¾Œã¾ã§ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

export default function Page({ children }) {
  return (
    <Layout meta={meta}>
      <>
        {children}
      </>
    </Layout>
  )
}

