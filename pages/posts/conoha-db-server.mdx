import { Layout } from 'lib/components'
import { RichLink, RichList, RichListNoBox, CodeBlockTitle, MdxImage } from "lib/components/original/parts";

export const meta = {
  title: 'Conoha VPSでMySQL DB負荷分散したいときは、「DBサーバ」インスタンスではなくVPSを使って行う。',
  date: '2023-10-21T18:15:00.000Z',
  tags: [
    'Blog',
    '初級者向け',
    'プログラミング',
    'Conoha',
    'VPS',
    'DB',
    'RDBMS',
    '負荷分散',
    'スケールアウト'
  ],
  description: 'Conoha VPSはコストパフォーマンスに優れ、気軽にWebサービス運営を始められるので人気ですが、負荷分散はどうするのか。検討したので詳しくまとめました。'
}

## 問題が生じた経緯

[Conoha VPS](https://www.conoha.jp/vps/)で運営しているWebサービスのDB負荷が高じてきたため、
<span class="hoso">スケールアウトによるMySQLのMaster-Slave体制への移行</span>を検討した。

### 結論
**先に結論からお伝えします。**

Conoha VPSでDB負荷分散を行いたい場合、

- 汎用VPSをMySQLようにもう一つ立て、プライベートネットワークに設置してDBサーバとして使う。今回のケースの場合は２台建てる。
- 外部MySQLサーバを使う。AWS RDSがいちばんの候補だが、セキュリティ面で気になる。
- PlanetScaleを使う。マネージドサービスで長期に渡りインフラ保守に気を配らなくてよく楽だが、月額費用が嵩むかもしれない。また、foreign keyを使っている場合は利用できない。

のどれかとなると思います。
<br />
PlanetScaleについては、ご興味がございましたら弊ブログの以下の記事も参考になさってください。

参考記事[サーバがなくてもMySQLが使える！PlanetScaleとNext.jsを組み合わせ速攻でDBに接続する方法。](https://moldspoon.jp/blog/posts/add-planetscale-to-nextjs-project)
<br />
以下検討経緯について詳しく書いていきます。

## 検討経緯

### ConohaにあるDB構成図を見つける。

検討を始めて最初に行き当たったのがこちら。
[大規模Webアプリケーション](https://www.conoha.jp/vps/example/05/)

Conohaの公式が提供する構成図で

>ロードバランサーに複数のWebサーバーが接続され、プライベートネットワーク側にはデータベースサーバーを接続した構成です。データベースはマスター/スレーブ構成になっていますが、ConoHaのプライベートネットワークは1Gbpsなのでレプリケーションなど大量のデータが流れる場合でも、安定したパフォーマンスを提供します。

とあります。ただ、公式で[DBサーバー](https://www.conoha.jp/database/)インスタンスが用意されているのに、**この構成図では何をインスタンスとして用いているのかが明言されずよくわかりません。** 

仕方がないので、GUIから「DBサーバー」インスタンスを立ち上げ、挙動を確認しました。

### DBサーバーの癖

GUIを触りつつ、並行して調査を行い、以下のことがわかりました。

- 実質的にはVPSで他の利用者と共用
- CPU/メモリのスペックは公開されていないが、どうやら汎用VPSと同じものを使っている（ように見える。）
- 最安で648円(税込)@ストレージSSD 10GB ~とかなり安い。**IPaaS的なRDBMSでは最安に近い。**
- [専用のDB接続用ネットワークが用意されている](https://www.conoha.jp/database/) 下記引用
- [PhpMyAdmin](https://www.phpmyadmin.net/)がマネージドで利用できる。セキュリティホールができやすいソフトなので、Conoha側に保守・アップデートを一任できるのは必要な人には便利そう（自分は使わない）
- SSHトンネリングを利用せずローカルから直接専用できる専用のドメインが振られる。IPを絞ればセキュリティ面でも比較的安心そう。

<MdxImage month="202310" image="conoha1.png?n=1" alt="潤沢なリソースでConoha内のネットワーク問題はあまりなさそうに見える" />

#### きつそうなポイント

ウィークポイントもわかってきました。

- MariaDBしか選べない。MySQLは選択できない。
- データベース名に必ず`4kdaz_`のような接頭辞がつく。仮想MySQLサーバで、他のユーザーと共用しなければいけないのが原因か。（具体的な仮想化技術までは追えてない）
- デフォルトのデータベース文字セットがUTF8しか選べず、絵文字などが文字化けする可能性。もっとも解決策は用意されている。

utf8をutf8mb4に指定すると、以下データベースでテーブルを作るときはutf8mb4になるので、この点の対応の手間を惜しまないでできる方は
アリかもしれません。具体的な方法は下記のURLをご覧ください。

参考記事:[ConoHa DBサーバー でutf8mb4を利用する方法](https://zenn.dev/takumi1001/articles/1273c14d6a6d5f)

##### 強みの「DBサーバ接続用ネットワーク」は接続時に再起動が必要

**DBサーバ接続用ネットワーク** は一種のプライベートネットワークのようで、接続にあたりWebサーバとして利用しているVPSは必ず再起動をかける必要があるようです。
もっとも**この点はAWSなども同じなのでそこまで気になりません**。サービスの停止が伴うことは覚えておく必要があります。

また、その<span className="hoso">専用ネットワークのNICに接続する設定を、各VPSで都度行う必要があり、接続元のWebサーバの数が多い場合はちょっと面倒そう</span>です。

詳しい手順は以下のURLをご覧ください。

参考ページ: [ご利用ガイド DBサーバー接続用ネットワークを使う](https://support.conoha.jp/v/dbnetwork/#:~:text=%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E6%8E%A5%E7%B6%9A%E7%94%A8%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AF,%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%80%82)

## 構成図について問い合わせた

この時点で検討材料がいろいろ出ましたので、Conohaのサポートご担当者様に問い合わせフォームから直接確認を行いました。
<br />
結果、**「構成図に記載があるDBサーバーは汎用VPSでの運用を想定している」** とのご返答をいただきました。
よって、マネージドのインスタンス「DBサーバー」はこの構成案では使用できないことが判明しました。

**GUIからMaster/Slaveの構成を実現できないかとの期待も少々あり** 実際にインスタンスを立ち上げて確認するなどもしたものの流石に無理でした。
<span className="hoso">ConohaでMySQLサーバの複数台構成による負荷分散を行いたい場合は、汎用VPSを立ち上げ、プライベートネットワークに向けてポートを開き、レプリケーション用のユーザーを作成する以外に方法がなさそう</span>でした。

## まとめ

現代においてマネージドであることがインフラ面での保守運用コストを大きく下げることにつながるため、負荷分散を考慮した利用用途で
「DBサーバ」インスタンスが使用できないことは少々残念ではありましたが、**とてもコストパフォーマンスに優れているConohaさんのサービスですので
贅沢は言ってはいけない** と思いました。

AWS RDSの最小レベルの構成（例えばdb.t3.micro、ストレージ10GB程度）でも、日本円で3,000円/月くらいはかかるので、<span className="hoso">648円/月~という低価格でマネージメントRDBMSを提供されているConohaさんは素晴らしいと改めて感じた</span>次第でした！

この記事が何かのお役に立てれば幸いです。<br />
最後までお読みいただきありがとうございました！

export default function Page({ children }) {
  return (
    <Layout meta={meta}>
      <>
        {children}
      </>
    </Layout>
  )
}

