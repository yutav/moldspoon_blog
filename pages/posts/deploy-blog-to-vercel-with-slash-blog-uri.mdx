import { Layout } from 'lib/components'
import { Button } from '@geist-ui/core'
import ShareButton from "../../lib/components/original/parts/ShareButtons"

import { useRouter } from 'next/router'

export const meta = {
  title: 'Next.jsで作ったブログを、別プロジェクトのNext.jsと同じドメインでVercel配信したい。',
  date: '2023-07-24T00:00:00.000Z',
}

こんにちは、[yuku_tas](https://twitter.com/yuku_tas)です。

### 本記事のゴール

元々[MoldSpoon Inc. のWebサイト](https://moldspoon.jp/)が動いていたNext.jsプロジェクトの下に、
さらにNext.jsプロジェクトのブログを作って配信したいと思いました。

* moldspoon.jp/blog 以下の全てのリクエストは子プロジェクト（ブログ）で補足
* moldspoon.jp/ 以下の全てのリクエストは親プロジェクトで補足


### 作業

公式ドキュメントをあたったところ、[rewrite](https://vercel.com/docs/concepts/edge-network/rewrites)という方法があるようです。

以下のように、**別途Vercelにデプロイしているプロジェクトの固定ドメインにもリンクが貼れる**ようです。

```
{
  "rewrites": [
    {
      "source": "/blog/:path*",
      "destination": "https://xxxx-vercel.app/:path*"
    }
  ]
}
```

こちらを親プロジェクトに `vercel.json`というファイル名でプロジェクトルート直下に作成。

続いて、子プロジェクトの `next.config.js`に以下の設定を追加します。

（私は/blog以下にデプロイしたいのでそうしました）
```
const nextConfig = {
...
+  assetPrefix: '/blog',
...
}

module.exports = withMDX(nextConfig)
```

この設定がないと、https://xxx.com/blog　にリクエストした途端リダイレクトループ(308ステータス)に陥るので必ず設定が必要です。
今回はここがハマりポイントでした...

これで、
```
https://moldspoon.jp/blog => https://子プロジェクトの識別子-vercel.app/
```
にリダイレクトができるようになりました。

/blogで子プロジェクトを開いたときに真っ白になってしまう場合は、javascriptのパスの疎通を疑ってconsoleを開いてデバッグした方がいいです。

### まとめ

- 親プロジェクトのvercel.jsonに `rewrite`設定を追加
- 子プロジェクトのnext.config.jsに `assetPrefix`を追加
- 両方のプロジェクトをデプロイ

export default function Page({ children }) {
  const router = useRouter();
  const currentUrl = typeof window !== 'undefined' ? window.location.href : '';
  const title = typeof document !== 'undefined' ? document.title : '';
  return (
    <Layout meta={meta}>
      <>
        {children}
        <ShareButton url={currentUrl} title={title} />
      </>
    </Layout>
  )
}
